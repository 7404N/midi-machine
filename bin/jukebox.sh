#!/bin/bash
# Plays song generated by a model continuously until stopped.
#
# (c) 2014 Brandon L. Reiss
####

prog=`basename $0`

usage () {
    echo """
Usage: $prog INPUT_DIR MODEL_PATH LENGTH
Compose a new song from a model.
  <INPUT_DIR> directory where input *.mid files reside
  <MODEL_PATH> path to trained model
  <LENGTH> length of generated songs
"""
}

script_dir=`dirname $0`
compose_script="${script_dir}/compose.lua"

# Look for compose script.
if [ ! -f "${compose_script}" ]; then
    echo 'Cannot find compose.lua in script directory' 1>&2
    exit 1
fi

# See if we have timidity player.
if ! which timidity >/dev/null 2>&1 ; then
    echo 'MIDI player timidity not found; install dependencies' 1>&2
    exit 1
fi

# Get args.
if [ ! $# == 3 ]; then
    echo 'Invalid arguments' 1>&2
    usage
    exit 1
fi

input_dir=$1; shift
model_path=$1; shift
length=$1; shift

# Choose temp location.

date_str=`date +%Y%m%d_%H%M%S`
output_dir="/tmp/jukebox-${date_str}"
echo Using output dir: ${output_dir}

# Make sure output_dir exists.

mkdir ${output_dir} >/dev/null 2>&1
if [ ! -d "${output_dir}" ]; then
    echo "Failed creating output directory ${output_dir}" 1>&2
    exit 1
fi

# Create a long sequence of songs (we'll probably quit before then).

th "${compose_script}" -n "${filename}" \
    "${input_dir}" "${model_path}" ${length} "${output_dir}" \
    -n gen -c 10000 -p

